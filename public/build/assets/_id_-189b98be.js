import{_ as Y}from"./AppSelect-c5fa0cad.js";import{_ as ee}from"./AppDateTimePicker-cff31852.js";import{_ as j}from"./AppTextField-07b9446e.js";import{e as te}from"./helpers-929cea30.js";import{f as ae,s as L}from"./fetchStudentData-5d34c1fd.js";import{V as le}from"./VNodeRenderer-d7a79f84.js";import{r as g,H as G,be as U,w as k,aY as Q,a as oe,o as C,f as F,e as l,d as v,b as e,n as u,a0 as E,c as z,I as H,x as I,v as A,z as W,F as se,i as ne,ai as B,j as re,k as ie,a5 as M,b5 as ue,aU as K}from"./main-7a04a4cc.js";import{u as P}from"./useApi-c87e68ce.js";import{V as O}from"./VRow-9ddfb65a.js";import{V as x}from"./VCol-3541d7c7.js";import{V as T}from"./VCard-c1d86edf.js";import{V as D}from"./VCardText-89ccd074.js";import{V as J}from"./VDivider-cd55d271.js";import{V as de}from"./VAlert-5ede27f5.js";import"./form-41eb478e.js";import"./VSelect-5fc0c42c.js";import"./VTextField-8b5d0ff7.js";/* empty css                   */import"./VCounter-9d080591.js";import"./VImg-785fe2da.js";import"./VField-eef30866.js";import"./easing-9f15041e.js";import"./VInput-5d1e9d15.js";import"./forwardRefs-8348545e.js";import"./VList-b9dbaad8.js";import"./ssrBoot-30a14e97.js";import"./VAvatar-a8f8d7de.js";import"./dialog-transition-839434e1.js";import"./VMenu-78d9b91a.js";import"./VOverlay-7dfacdbb.js";import"./lazy-916f73d1.js";import"./scopeId-e82d8d9c.js";import"./VCheckboxBtn-e67cbaff.js";import"./VSelectionControl-ff913cdc.js";import"./VChip-6b0b1728.js";import"./no-profile-4221a4a6.js";const me={class:"pa-5 flex-grow-1"},ce={class:"d-flex flex-column justify-space-between border-s pa-1"},pe={__name:"paymentItemEdit",props:{id:{type:Number,required:!0},data:{type:Object,required:!0},year:{type:[String,Number],required:!0},category:{type:String,required:!0},registered:{type:[String,Number],required:!0}},emits:["remove","update:data"],setup(R,{emit:w}){const y=R,V=w,m=g();G(async()=>{const{data:d,error:r}=await P("/accounts");r.value?console.log(r.value):m.value=d.value.data.filter(n=>n.unit==="Pembayaran")});const s=g(structuredClone(U(y.data)));let _=!1;k(s,d=>{_||V("update:data",d)},{deep:!0}),k(()=>y.data,d=>{_=!0,s.value=structuredClone(U(d)),Q(()=>{_=!1})},{deep:!0});const f=g([]),b=async(d,r,n)=>{var o;if(!d||!r||r==="Not Set"){f.value=[];return}try{const{data:i}=await P(`/billings-by-year/${n}/${r}`);if((o=i.value)!=null&&o.data){const p=["Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","Jun"];f.value=i.value.data.flatMap(t=>{if(t.is_monthly)return p.map((c,q)=>{const $=q<6?d:Number(d)+1,N=`${t.name} ${c}-${$}`;return{title:N,value:N,amount:t.amount}});if(t.is_once){const c=`${t.name} ${n}`;return{title:c,value:c,amount:t.amount}}const a=`${t.name} ${d}`;return{title:a,value:a,amount:t.amount}})}else f.value=[]}catch(i){console.error("Failed to fetch billings:",i),f.value=[]}};k([()=>y.year,()=>y.category],([d,r])=>{s.value.billing="",s.value.amount=0,b(d,r,y.registered)},{immediate:!0}),k(()=>s.value.billing,d=>{if(d){const r=f.value.find(n=>n.value===d);r&&(s.value.amount=r.amount)}});const S=()=>{V("remove",y.id)};return(d,r)=>{const n=Y,o=oe("IconBtn");return C(),F(T,{flat:"",border:"",class:"d-flex flex-row"},{default:l(()=>[v("div",me,[e(O,null,{default:l(()=>[e(x,{cols:"12",sm:"5"},{default:l(()=>[e(n,{modelValue:u(s).finance_account_id,"onUpdate:modelValue":r[0]||(r[0]=i=>u(s).finance_account_id=i),items:u(m),"item-title":i=>`${(i==null?void 0:i.number)||""} - ${(i==null?void 0:i.description)||""}`,"item-value":"id",label:"Account"},null,8,["modelValue","items","item-title"])]),_:1}),e(x,{cols:"12",sm:"4"},{default:l(()=>[e(n,{modelValue:u(s).billing,"onUpdate:modelValue":r[1]||(r[1]=i=>u(s).billing=i),label:"Description",placeholder:"Billing Description",items:u(f),"item-title":"title","item-value":"value"},null,8,["modelValue","items"])]),_:1}),e(x,{cols:"12",sm:"3"},{default:l(()=>[e(j,{modelValue:u(s).amount,"onUpdate:modelValue":r[2]||(r[2]=i=>u(s).amount=i),label:"Amount",placeholder:"Amount",type:"number"},null,8,["modelValue"])]),_:1})]),_:1})]),v("div",ce,[e(o,{onClick:S},{default:l(()=>[e(E,{size:"20",icon:"tabler-x"})]),_:1}),e(o,null,{default:l(()=>[e(E,{size:"20",icon:"tabler-settings"})]),_:1})])]),_:1})}}},fe={key:0,class:"ma-sm-4"},ve={class:"d-flex align-center mb-6"},ye={class:"font-weight-bold text-capitalize text-h4"},_e={class:"mb-0"},be={class:"my-2"},ge={class:"mb-0"},he={class:"mt-4 ma-sm-4"},Ve={class:"d-flex align-center font-weight-medium justify-sm-end text-xl mb-3"},xe={class:"mt-6 ms-sm-4"},we={__name:"paymentEditable",props:{invoiceNumber:String,data:{type:null,required:!0}},emits:["push","remove","update:data"],setup(R,{emit:w}){const y=R,V=w,m=g(structuredClone(U(y.data)));let h=!1;k(m,n=>{h||V("update:data",n)},{deep:!0}),k(()=>y.data,n=>{h=!0,m.value=structuredClone(U(n)),Q(()=>{h=!1})},{deep:!0});const s=(n,o)=>{m.value.paymentItem[n]=o},_=g([]),f=g(""),b=g(0),S=async()=>{const{data:n,error:o}=await P("/schools");o.value?console.log(o.value):_.value=n.value};G(()=>{ae(),S()}),k(()=>m.value.header.date,n=>{m.value.header.period=n?te(n):""}),k(()=>m.value.header.admin_student_id,n=>{if(n){const o=L.value.find(i=>i.id===n);o?(f.value=o.payment_category,b.value=o.registered||0):(f.value="",b.value=0)}else f.value="",b.value=0},{immediate:!0});const d=()=>{V("push")},r=n=>{V("remove",n)};return(n,o)=>{const i=Y;return C(),F(T,null,{default:l(()=>[e(D,{class:"d-flex flex-wrap justify-space-between gap-y-5 flex-column flex-sm-row"},{default:l(()=>{var p,t;return[(t=(p=_.value)==null?void 0:p.data)!=null&&t.length?(C(),z("div",fe,[v("div",ve,[e(u(le),{nodes:u(H).app.logo,class:"me-3"},null,8,["nodes"]),v("h6",ye,I(u(H).app.title),1)]),v("p",_e,[A(I(_.value.data[0].name)+" âœª ",1),v("strong",null,I(_.value.data[0].organization),1)]),v("p",be,I(_.value.data[0].address),1),v("p",ge,[e(E,{icon:"tabler-phone",class:"me-2"}),A(" "+I(_.value.data[0].phone)+" ",1),e(E,{icon:"tabler-mail",class:"mx-2"}),A(" "+I(_.value.data[0].email),1)])])):W("",!0),v("div",he,[v("h6",Ve,[v("span",null,[e(j,{"model-value":y.invoiceNumber,disabled:"",prefix:"#",density:"compact",style:{"inline-size":"9.5rem"}},null,8,["model-value"])])])])]}),_:1}),e(J),e(D,{class:"d-flex flex-wrap justify-space-between flex-column flex-sm-row"},{default:l(()=>[e(O,null,{default:l(()=>[e(x,{cols:"12",sm:"6",md:"3"},{default:l(()=>[e(ee,{modelValue:m.value.header.date,"onUpdate:modelValue":o[0]||(o[0]=p=>m.value.header.date=p),label:"Date",density:"compact"},null,8,["modelValue"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:l(()=>[e(j,{modelValue:m.value.header.period,"onUpdate:modelValue":o[1]||(o[1]=p=>m.value.header.period=p),label:"Period",type:"number",density:"compact"},null,8,["modelValue"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:l(()=>[e(i,{modelValue:m.value.header.admin_student_id,"onUpdate:modelValue":o[2]||(o[2]=p=>m.value.header.admin_student_id=p),items:u(L),"item-title":"nickname","item-value":"id",label:"Student",density:"compact"},null,8,["modelValue","items"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:l(()=>[e(j,{modelValue:f.value,"onUpdate:modelValue":o[3]||(o[3]=p=>f.value=p),label:"Payment Category",readonly:"",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(J),e(D,{class:"add-products-form"},{default:l(()=>[(C(!0),z(se,null,ne(m.value.paymentItem,(p,t)=>(C(),z("div",{key:t,class:"my-4 ma-sm-4"},[e(pe,{id:t,data:p,year:m.value.header.period,category:f.value,registered:b.value,"onUpdate:data":a=>s(t,a),onRemove:r},null,8,["id","data","year","category","registered","onUpdate:data"])]))),128)),v("div",xe,[e(B,{onClick:d},{default:l(()=>o[4]||(o[4]=[A(" Add Item ")])),_:1})])]),_:1}),e(J)]),_:1})}}},$e={class:"text-center text-h4 font-weight-medium my-2"},rt={__name:"[id]",async setup(R){let w,y;const V=re(),m=ie(),h=M(()=>V.params.id),s=g({header:{invoice:"",date:"",period:"",admin_student_id:""},paymentItem:[]});if(h.value&&h.value!=="new"){const{data:t}=([w,y]=ue(()=>P(`/payments-by-invoice/${h.value}`)),w=await w,y(),w);if(t.value&&t.value.data.length>0){const a=t.value.data,c=a[0];s.value.header={invoice:c.invoice,date:c.date,period:c.period,admin_student_id:c.admin_student_id},s.value.paymentItem=a}}const _=()=>{var t;(t=s.value)==null||t.paymentItem.push({finance_account_id:"",billing:"",amount:0})},f=t=>{var a;(a=s.value)==null||a.paymentItem.splice(t,1)},b=g(!1),S=g(""),d=g("primary"),r=(t,a="primary")=>{S.value=t,d.value=a,b.value=!0,setTimeout(()=>{b.value=!1},1e4)},n=M(()=>{var a;const t=s.value.header;if(!t.date||!t.period||!t.admin_student_id)return!1;if(((a=s.value)==null?void 0:a.paymentItem.length)>0){for(const c of s.value.paymentItem)if(!c.amount)return!1}return!0}),o=g(!1),i=async()=>{var a,c;o.value=!0;const t=U(s.value);h.value!=="new"&&(t.header.invoice=h.value);try{const{data:q,error:$}=await P("/payments/bulk-store",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",Accept:"application/json"}});if($.value){if((a=$.value.data)!=null&&a.errors){const N=$.value.data.errors,X=Object.keys(N)[0],Z=N[X][0];r(`Save failed: ${Z}`,"error")}else(c=$.value.data)!=null&&c.message?r(`An error occurred: ${$.value.data.message}`,"error"):r("An unknown error occurred while saving. Please check the console.","error");console.error("Error saving payment:",$.value)}else m.push(`/financial/payment/edit/${q.value.data.invoice}`),r("Data berhasil disimpan!","success")}finally{o.value=!1}},p=M(()=>s.value.paymentItem.reduce((t,a)=>t+(Number(a.amount)||0),0));return(t,a)=>(C(),F(O,null,{default:l(()=>[e(x,{cols:"12",md:"12"},{default:l(()=>[e(de,{modelValue:u(b),"onUpdate:modelValue":a[0]||(a[0]=c=>K(b)?b.value=c:null),closable:"",class:"mb-6",color:u(d)},{default:l(()=>[A(I(u(S)),1)]),_:1},8,["modelValue","color"]),e(O,null,{default:l(()=>[e(x,{cols:"12",md:"9"},{default:l(()=>[u(s)?(C(),F(we,{key:0,data:u(s),"onUpdate:data":a[1]||(a[1]=c=>K(s)?s.value=c:null),"invoice-number":u(h),onPush:_,onRemove:f},null,8,["data","invoice-number"])):W("",!0)]),_:1}),e(x,{cols:"12",md:"3"},{default:l(()=>[e(T,{class:"mb-8"},{default:l(()=>[e(D,null,{default:l(()=>[e(B,{loading:u(o),disabled:!u(n),block:"",class:"mb-2",color:"success",onClick:i},{default:l(()=>a[2]||(a[2]=[A(" Save payment ")])),_:1},8,["loading","disabled"]),e(B,{block:"",color:"secondary",variant:"tonal",class:"mb-2",disabled:u(V).params.id==="new",to:{name:"financial-payment-preview-id",params:{id:u(V).params.id}}},{default:l(()=>a[3]||(a[3]=[A(" Preview ")])),_:1},8,["disabled","to"]),e(B,{block:"",color:"secondary",variant:"tonal",to:{name:"financial-payment-list"}},{default:l(()=>a[4]||(a[4]=[A(" Exit ")])),_:1})]),_:1})]),_:1}),e(T,null,{default:l(()=>[e(D,null,{default:l(()=>[a[5]||(a[5]=v("div",{class:"text-high-emphasis"}," Total ",-1)),v("div",$e,I(Number(u(p)).toLocaleString("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0})),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}};export{rt as default};
