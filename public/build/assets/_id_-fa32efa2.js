import{_ as Y}from"./AppSelect-3e238d9d.js";import{_ as ee}from"./AppDateTimePicker-828009d3.js";import{_ as B}from"./AppTextField-862a83a4.js";import{e as ae}from"./helpers-10cbd28e.js";import{f as te,s as j}from"./fetchStudentData-923239c4.js";import{V as le}from"./VNodeRenderer-75612b94.js";import{r as g,H as G,be as U,w as A,aY as Q,a as oe,o as S,f as F,e as n,d as f,b as a,a0 as O,c as M,n as p,I as H,x as I,v as k,z as W,F as ne,i as se,ai as E,j as ie,k as re,a5 as J,b5 as ue,aU as K}from"./main-ee7c17de.js";import{u as P}from"./useApi-ee5b865a.js";import{V as T}from"./VRow-271260dd.js";import{V as x}from"./VCol-cfb71e73.js";import{V as q}from"./VCard-cba44afa.js";import{V as N}from"./VCardText-6be2f581.js";import{V as L}from"./VDivider-5a8f189b.js";import{V as de}from"./VAlert-8e2387b3.js";import"./form-baa91886.js";import"./VSelect-cea4b28e.js";import"./VTextField-65dae01b.js";/* empty css                   */import"./VCounter-97a26890.js";import"./VImg-d487f910.js";import"./VField-2b6b59c0.js";import"./easing-9f15041e.js";import"./VInput-29651115.js";import"./forwardRefs-8348545e.js";import"./VList-dd2cb195.js";import"./ssrBoot-c8beb59b.js";import"./VAvatar-4667946e.js";import"./dialog-transition-9860be03.js";import"./VMenu-6af39dc3.js";import"./VOverlay-9c9ed528.js";import"./lazy-ad9bbcd3.js";import"./scopeId-f06193c4.js";import"./VCheckboxBtn-0cef0367.js";import"./VSelectionControl-fc422a63.js";import"./VChip-7b4a1ec4.js";import"./no-profile-4221a4a6.js";const me={class:"pa-5 flex-grow-1"},ce={class:"d-flex flex-column justify-space-between border-s pa-1"},pe={__name:"paymentItemEdit",props:{id:{type:Number,required:!0},data:{type:Object,required:!0},year:{type:[String,Number],required:!0},category:{type:String,required:!0},registered:{type:[String,Number],required:!0}},emits:["remove","update:data"],setup(R,{emit:w}){const _=R,V=w,d=g([]);G(async()=>{const{data:m,error:s}=await P("/accounts");s.value?console.error("Error fetching accounts:",s.value):d.value=m.value.data.filter(o=>o.unit==="Pembayaran")});const t=g(structuredClone(U(_.data)));let y=!1;A(t,m=>{y||V("update:data",m)},{deep:!0}),A(()=>_.data,m=>{y=!0,t.value=structuredClone(U(m)),Q(()=>{y=!1})},{deep:!0});const v=g([]),b=async(m,s,o)=>{var i;if(!m||!s||s==="Not Set"){v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id="";return}try{const{data:u}=await P(`/billings-by-year/${o}/${s}`);if((i=u.value)!=null&&i.data){const r=["Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","Jun"];v.value=u.value.data.flatMap(e=>{if(e.is_monthly)return r.map((c,z)=>{const $=z<6?m:Number(m)+1,D=`${e.name} ${c}-${$}`;return{title:D,value:D,amount:e.amount,finance_account_id:e.finance_account_id}});if(e.is_once){const c=`${e.name} ${o}`;return{title:c,value:c,amount:e.amount,finance_account_id:e.finance_account_id}}const l=`${e.name} ${m}`;return{title:l,value:l,amount:e.amount,finance_account_id:e.finance_account_id}})}else v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}catch(u){console.error("Failed to fetch billings:",u),v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}};A([()=>_.year,()=>_.category,()=>_.registered],([m,s,o])=>{s&&s!=="Not Set"&&b(m,s,o)},{immediate:!0}),A(()=>t.value.billing,m=>{if(m){const s=v.value.find(o=>o.value===m);s&&(t.value.amount=s.amount,t.value.finance_account_id=s.finance_account_id)}else t.value.amount=0,t.value.finance_account_id=""});const C=()=>{V("remove",_.id)};return console.log("localData child child",t.value),(m,s)=>{const o=Y,i=oe("IconBtn");return S(),F(q,{flat:"",border:"",class:"d-flex flex-row"},{default:n(()=>[f("div",me,[a(T,null,{default:n(()=>[a(x,{cols:"12",sm:"5"},{default:n(()=>[a(o,{modelValue:t.value.finance_account_id,"onUpdate:modelValue":s[0]||(s[0]=u=>t.value.finance_account_id=u),items:d.value,"item-title":u=>{const r=d.value.find(e=>e.id===(u.id||u));return r?`${r.number} - ${r.description}`:u.id||u},"item-value":"id",label:"Account"},null,8,["modelValue","items","item-title"])]),_:1}),a(x,{cols:"12",sm:"4"},{default:n(()=>[a(o,{modelValue:t.value.billing,"onUpdate:modelValue":s[1]||(s[1]=u=>t.value.billing=u),label:"Description",placeholder:"Billing Description",items:v.value,"item-title":"title","item-value":"value"},null,8,["modelValue","items"])]),_:1}),a(x,{cols:"12",sm:"3"},{default:n(()=>[a(B,{modelValue:t.value.amount,"onUpdate:modelValue":s[2]||(s[2]=u=>t.value.amount=u),label:"Amount",placeholder:"Amount",type:"number"},null,8,["modelValue"])]),_:1})]),_:1})]),f("div",ce,[a(i,{onClick:C},{default:n(()=>[a(O,{size:"20",icon:"tabler-x"})]),_:1}),a(i,null,{default:n(()=>[a(O,{size:"20",icon:"tabler-settings"})]),_:1})])]),_:1})}}},ve={key:0,class:"ma-sm-4"},fe={class:"d-flex align-center mb-6"},_e={class:"font-weight-bold text-capitalize text-h4"},ye={class:"mb-0"},be={class:"my-2"},ge={class:"mb-0"},he={class:"mt-4 ma-sm-4"},Ve={class:"d-flex align-center font-weight-medium justify-sm-end text-xl mb-3"},xe={class:"mt-6 ms-sm-4"},we={__name:"paymentEditable",props:{invoiceNumber:String,data:{type:null,required:!0}},emits:["push","remove","update:data"],setup(R,{emit:w}){const _=R,V=w,d=g(structuredClone(U(_.data)));let h=!1;A(d,o=>{h||V("update:data",o)},{deep:!0}),A(()=>_.data,o=>{h=!0,d.value=structuredClone(U(o)),Q(()=>{h=!1})},{deep:!0});const t=(o,i)=>{d.value.paymentItem[o]=i},y=g([]),v=g(""),b=g(0),C=async()=>{const{data:o,error:i}=await P("/schools");i.value?console.log(i.value):y.value=o.value};G(()=>{te(),C()}),A(()=>d.value.header.date,o=>{d.value.header.period=o?ae(o):""}),A([()=>d.value.header.admin_student_id,j],([o,i])=>{if(!(!o||i.length===0))if(o){const u=j.value.find(r=>r.id===o);u?(v.value=u.payment_category,b.value=u.registered||0):(v.value="",b.value=0)}else v.value="",b.value=0},{immediate:!0});const m=()=>{V("push")},s=o=>{V("remove",o)};return console.log("localData child",d.value),(o,i)=>{const u=Y;return S(),F(q,null,{default:n(()=>[a(N,{class:"d-flex flex-wrap justify-space-between gap-y-5 flex-column flex-sm-row"},{default:n(()=>{var r,e;return[(e=(r=y.value)==null?void 0:r.data)!=null&&e.length?(S(),M("div",ve,[f("div",fe,[a(p(le),{nodes:p(H).app.logo,class:"me-3"},null,8,["nodes"]),f("h6",_e,I(p(H).app.title),1)]),f("p",ye,[k(I(y.value.data[0].name)+" âœª ",1),f("strong",null,I(y.value.data[0].organization),1)]),f("p",be,I(y.value.data[0].address),1),f("p",ge,[a(O,{icon:"tabler-phone",class:"me-2"}),k(" "+I(y.value.data[0].phone)+" ",1),a(O,{icon:"tabler-mail",class:"mx-2"}),k(" "+I(y.value.data[0].email),1)])])):W("",!0),f("div",he,[f("h6",Ve,[f("span",null,[a(B,{"model-value":_.invoiceNumber,disabled:"",prefix:"#",density:"compact",style:{"inline-size":"9.5rem"}},null,8,["model-value"])])])])]}),_:1}),a(L),a(N,{class:"d-flex flex-wrap justify-space-between flex-column flex-sm-row"},{default:n(()=>[a(T,null,{default:n(()=>[a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(ee,{modelValue:d.value.header.date,"onUpdate:modelValue":i[0]||(i[0]=r=>d.value.header.date=r),label:"Date",density:"compact"},null,8,["modelValue"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(B,{modelValue:d.value.header.period,"onUpdate:modelValue":i[1]||(i[1]=r=>d.value.header.period=r),label:"Period",type:"number",density:"compact"},null,8,["modelValue"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(u,{modelValue:d.value.header.admin_student_id,"onUpdate:modelValue":i[2]||(i[2]=r=>d.value.header.admin_student_id=r),items:p(j),"item-title":r=>{const e=p(j).find(l=>l.id===(r.id||r));return e?e.nickname:r.id||r},"item-value":"id",label:"Student",density:"compact"},null,8,["modelValue","items","item-title"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(B,{modelValue:v.value,"onUpdate:modelValue":i[3]||(i[3]=r=>v.value=r),label:"Payment Category",readonly:"",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(L),a(N,{class:"add-products-form"},{default:n(()=>[(S(!0),M(ne,null,se(d.value.paymentItem,(r,e)=>(S(),M("div",{key:e,class:"my-4 ma-sm-4"},[a(pe,{id:e,data:r,year:d.value.header.period,category:v.value,registered:b.value,"onUpdate:data":l=>t(e,l),onRemove:s},null,8,["id","data","year","category","registered","onUpdate:data"])]))),128)),f("div",xe,[a(E,{onClick:m},{default:n(()=>i[4]||(i[4]=[k(" Add Item ")])),_:1})])]),_:1}),a(L)]),_:1})}}},$e={class:"text-center text-h4 font-weight-medium my-2"},ia={__name:"[id]",async setup(R){let w,_;const V=ie(),d=re(),h=J(()=>V.params.id),t=g({header:{invoice:"",date:"",period:"",admin_student_id:""},paymentItem:[]});if(h.value&&h.value!=="new"){const{data:e}=([w,_]=ue(()=>P(`/payments-by-invoice/${h.value}`)),w=await w,_(),w);if(console.log("Raw invoiceData from API:",e.value),e.value&&e.value.data.length>0){const l=e.value.data,c=l[0];t.value.header={invoice:c.invoice,date:c.date,period:c.period,admin_student_id:c.admin_student_id},t.value.paymentItem=l}}const y=()=>{var e;(e=t.value)==null||e.paymentItem.push({finance_account_id:"",billing:"",amount:0})},v=e=>{var l;(l=t.value)==null||l.paymentItem.splice(e,1)},b=g(!1),C=g(""),m=g("primary"),s=(e,l="primary")=>{C.value=e,m.value=l,b.value=!0,setTimeout(()=>{b.value=!1},1e4)},o=J(()=>{var l;const e=t.value.header;if(!e.date||!e.period||!e.admin_student_id)return!1;if(((l=t.value)==null?void 0:l.paymentItem.length)>0){for(const c of t.value.paymentItem)if(!c.amount)return!1}return!0}),i=g(!1),u=async()=>{var l,c;i.value=!0;const e=U(t.value);h.value!=="new"&&(e.header.invoice=h.value);try{const{data:z,error:$}=await P("/payments/bulk-store",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",Accept:"application/json"}});if($.value){if((l=$.value.data)!=null&&l.errors){const D=$.value.data.errors,X=Object.keys(D)[0],Z=D[X][0];s(`Save failed: ${Z}`,"error")}else(c=$.value.data)!=null&&c.message?s(`An error occurred: ${$.value.data.message}`,"error"):s("An unknown error occurred while saving. Please check the console.","error");console.error("Error saving payment:",$.value)}else d.push(`/financial/payment/edit/${z.value.data.invoice}`),s("Data berhasil disimpan!","success")}finally{i.value=!1}},r=J(()=>t.value.paymentItem.reduce((e,l)=>e+(Number(l.amount)||0),0));return(e,l)=>(S(),F(T,null,{default:n(()=>[a(x,{cols:"12",md:"12"},{default:n(()=>[a(de,{modelValue:p(b),"onUpdate:modelValue":l[0]||(l[0]=c=>K(b)?b.value=c:null),closable:"",class:"mb-6",color:p(m)},{default:n(()=>[k(I(p(C)),1)]),_:1},8,["modelValue","color"]),a(T,null,{default:n(()=>[a(x,{cols:"12",md:"9"},{default:n(()=>[p(t)?(S(),F(we,{key:0,data:p(t),"onUpdate:data":l[1]||(l[1]=c=>K(t)?t.value=c:null),"invoice-number":p(h),onPush:y,onRemove:v},null,8,["data","invoice-number"])):W("",!0)]),_:1}),a(x,{cols:"12",md:"3"},{default:n(()=>[a(q,{class:"mb-8"},{default:n(()=>[a(N,null,{default:n(()=>[a(E,{loading:p(i),disabled:!p(o),block:"",class:"mb-2",color:"success",onClick:u},{default:n(()=>l[2]||(l[2]=[k(" Save payment ")])),_:1},8,["loading","disabled"]),a(E,{block:"",color:"secondary",variant:"tonal",class:"mb-2",disabled:p(V).params.id==="new",to:{name:"financial-payment-preview-id",params:{id:p(V).params.id}}},{default:n(()=>l[3]||(l[3]=[k(" Preview ")])),_:1},8,["disabled","to"]),a(E,{block:"",color:"secondary",variant:"tonal",to:{name:"financial-payment-list"}},{default:n(()=>l[4]||(l[4]=[k(" Exit ")])),_:1})]),_:1})]),_:1}),a(q,null,{default:n(()=>[a(N,null,{default:n(()=>[l[5]||(l[5]=f("div",{class:"text-high-emphasis"}," Total ",-1)),f("div",$e,I(Number(p(r)).toLocaleString("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0})),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}};export{ia as default};
