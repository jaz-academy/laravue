import{_ as Y}from"./AppSelect-0bbe1a5c.js";import{_ as ee}from"./AppDateTimePicker-a90ff731.js";import{_ as j}from"./AppTextField-3c315d47.js";import{e as ae}from"./helpers-dc843671.js";import{f as te,s as L}from"./fetchStudentData-90e9ceb1.js";import{V as le}from"./VNodeRenderer-55b91c89.js";import{r as g,H as G,be as U,w as A,aY as Q,a as oe,o as S,f as E,e as n,d as f,b as e,a0 as F,c as z,n as v,I as H,x as I,v as k,z as W,F as ne,i as se,ai as B,j as ie,k as re,a5 as M,b5 as ue,aU as K}from"./main-dd895efc.js";import{u as P}from"./useApi-d559f13e.js";import{V as O}from"./VRow-401a9eed.js";import{V as x}from"./VCol-5badd7d4.js";import{V as T}from"./VCard-521d2f55.js";import{V as N}from"./VCardText-8cb57704.js";import{V as J}from"./VDivider-3f5c8926.js";import{V as de}from"./VAlert-9784b9d3.js";import"./form-06ce0535.js";import"./VSelect-7ffe1379.js";import"./VTextField-c7c6ba66.js";/* empty css                   */import"./VCounter-be0294ff.js";import"./VImg-0d845f43.js";import"./VField-6a012775.js";import"./easing-9f15041e.js";import"./VInput-ec440a4f.js";import"./forwardRefs-8348545e.js";import"./VList-681543a0.js";import"./ssrBoot-fbb1ff66.js";import"./VAvatar-c43efe20.js";import"./dialog-transition-d429094b.js";import"./VMenu-6c524ca6.js";import"./VOverlay-e33c0891.js";import"./lazy-f6e07bc3.js";import"./scopeId-e894abda.js";import"./VCheckboxBtn-7fc5a6c7.js";import"./VSelectionControl-583fb587.js";import"./VChip-a60314c8.js";import"./no-profile-4221a4a6.js";const me={class:"pa-5 flex-grow-1"},ce={class:"d-flex flex-column justify-space-between border-s pa-1"},pe={__name:"paymentItemEdit",props:{id:{type:Number,required:!0},data:{type:Object,required:!0},year:{type:[String,Number],required:!0},category:{type:String,required:!0},registered:{type:[String,Number],required:!0}},emits:["remove","update:data"],setup(R,{emit:w}){const _=R,V=w,d=g([]);G(async()=>{const{data:u,error:i}=await P("/accounts");i.value?console.error("Error fetching accounts:",i.value):d.value=u.value.data.filter(o=>o.unit==="Pembayaran")});const t=g(structuredClone(U(_.data)));let y=!1;A(t,u=>{y||V("update:data",u)},{deep:!0}),A(()=>_.data,u=>{y=!0,t.value=structuredClone(U(u)),Q(()=>{y=!1})},{deep:!0});const p=g([]),b=async(u,i,o)=>{var s;if(!u||!i||i==="Not Set"){p.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id="";return}try{const{data:r}=await P(`/billings-by-year/${o}/${i}`);if((s=r.value)!=null&&s.data){const c=["Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","Jun"];p.value=r.value.data.flatMap(a=>{if(a.is_monthly)return c.map((m,q)=>{const $=q<6?u:Number(u)+1,D=`${a.name} ${m}-${$}`;return{title:D,value:D,amount:a.amount,finance_account_id:a.finance_account_id}});if(a.is_once){const m=`${a.name} ${o}`;return{title:m,value:m,amount:a.amount,finance_account_id:a.finance_account_id}}const l=`${a.name} ${u}`;return{title:l,value:l,amount:a.amount,finance_account_id:a.finance_account_id}})}else p.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}catch(r){console.error("Failed to fetch billings:",r),p.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}};A([()=>_.year,()=>_.category,()=>_.registered],([u,i,o])=>{i&&i!=="Not Set"&&b(u,i,o)},{immediate:!0}),A(()=>t.value.billing,u=>{if(u){const i=p.value.find(o=>o.value===u);i&&(t.value.amount=i.amount,t.value.finance_account_id=i.finance_account_id)}else t.value.amount=0,t.value.finance_account_id=""});const C=()=>{V("remove",_.id)};return console.log("localData child child",t.value),(u,i)=>{const o=Y,s=oe("IconBtn");return S(),E(T,{flat:"",border:"",class:"d-flex flex-row"},{default:n(()=>[f("div",me,[e(O,null,{default:n(()=>[e(x,{cols:"12",sm:"5"},{default:n(()=>[e(o,{modelValue:t.value.finance_account_id,"onUpdate:modelValue":i[0]||(i[0]=r=>t.value.finance_account_id=r),items:d.value,"item-title":r=>`${(r==null?void 0:r.number)||""} - ${(r==null?void 0:r.description)||""}`,"item-value":"id",label:"Account"},null,8,["modelValue","items","item-title"])]),_:1}),e(x,{cols:"12",sm:"4"},{default:n(()=>[e(o,{modelValue:t.value.billing,"onUpdate:modelValue":i[1]||(i[1]=r=>t.value.billing=r),label:"Description",placeholder:"Billing Description",items:p.value,"item-title":"title","item-value":"value"},null,8,["modelValue","items"])]),_:1}),e(x,{cols:"12",sm:"3"},{default:n(()=>[e(j,{modelValue:t.value.amount,"onUpdate:modelValue":i[2]||(i[2]=r=>t.value.amount=r),label:"Amount",placeholder:"Amount",type:"number"},null,8,["modelValue"])]),_:1})]),_:1})]),f("div",ce,[e(s,{onClick:C},{default:n(()=>[e(F,{size:"20",icon:"tabler-x"})]),_:1}),e(s,null,{default:n(()=>[e(F,{size:"20",icon:"tabler-settings"})]),_:1})])]),_:1})}}},ve={key:0,class:"ma-sm-4"},fe={class:"d-flex align-center mb-6"},_e={class:"font-weight-bold text-capitalize text-h4"},ye={class:"mb-0"},be={class:"my-2"},ge={class:"mb-0"},he={class:"mt-4 ma-sm-4"},Ve={class:"d-flex align-center font-weight-medium justify-sm-end text-xl mb-3"},xe={class:"mt-6 ms-sm-4"},we={__name:"paymentEditable",props:{invoiceNumber:String,data:{type:null,required:!0}},emits:["push","remove","update:data"],setup(R,{emit:w}){const _=R,V=w,d=g(structuredClone(U(_.data)));let h=!1;A(d,o=>{h||V("update:data",o)},{deep:!0}),A(()=>_.data,o=>{h=!0,d.value=structuredClone(U(o)),Q(()=>{h=!1})},{deep:!0});const t=(o,s)=>{d.value.paymentItem[o]=s},y=g([]),p=g(""),b=g(0),C=async()=>{const{data:o,error:s}=await P("/schools");s.value?console.log(s.value):y.value=o.value};G(()=>{te(),C()}),A(()=>d.value.header.date,o=>{d.value.header.period=o?ae(o):""}),A(()=>d.value.header.admin_student_id,o=>{if(o){const s=L.value.find(r=>r.id===o);s?(p.value=s.payment_category,b.value=s.registered||0):(p.value="",b.value=0)}else p.value="",b.value=0},{immediate:!0});const u=()=>{V("push")},i=o=>{V("remove",o)};return console.log("localData child",d.value),(o,s)=>{const r=Y;return S(),E(T,null,{default:n(()=>[e(N,{class:"d-flex flex-wrap justify-space-between gap-y-5 flex-column flex-sm-row"},{default:n(()=>{var c,a;return[(a=(c=y.value)==null?void 0:c.data)!=null&&a.length?(S(),z("div",ve,[f("div",fe,[e(v(le),{nodes:v(H).app.logo,class:"me-3"},null,8,["nodes"]),f("h6",_e,I(v(H).app.title),1)]),f("p",ye,[k(I(y.value.data[0].name)+" âœª ",1),f("strong",null,I(y.value.data[0].organization),1)]),f("p",be,I(y.value.data[0].address),1),f("p",ge,[e(F,{icon:"tabler-phone",class:"me-2"}),k(" "+I(y.value.data[0].phone)+" ",1),e(F,{icon:"tabler-mail",class:"mx-2"}),k(" "+I(y.value.data[0].email),1)])])):W("",!0),f("div",he,[f("h6",Ve,[f("span",null,[e(j,{"model-value":_.invoiceNumber,disabled:"",prefix:"#",density:"compact",style:{"inline-size":"9.5rem"}},null,8,["model-value"])])])])]}),_:1}),e(J),e(N,{class:"d-flex flex-wrap justify-space-between flex-column flex-sm-row"},{default:n(()=>[e(O,null,{default:n(()=>[e(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[e(ee,{modelValue:d.value.header.date,"onUpdate:modelValue":s[0]||(s[0]=c=>d.value.header.date=c),label:"Date",density:"compact"},null,8,["modelValue"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[e(j,{modelValue:d.value.header.period,"onUpdate:modelValue":s[1]||(s[1]=c=>d.value.header.period=c),label:"Period",type:"number",density:"compact"},null,8,["modelValue"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[e(r,{modelValue:d.value.header.admin_student_id,"onUpdate:modelValue":s[2]||(s[2]=c=>d.value.header.admin_student_id=c),items:v(L),"item-title":"nickname","item-value":"id",label:"Student",density:"compact"},null,8,["modelValue","items"])]),_:1}),e(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[e(j,{modelValue:p.value,"onUpdate:modelValue":s[3]||(s[3]=c=>p.value=c),label:"Payment Category",readonly:"",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(J),e(N,{class:"add-products-form"},{default:n(()=>[(S(!0),z(ne,null,se(d.value.paymentItem,(c,a)=>(S(),z("div",{key:a,class:"my-4 ma-sm-4"},[e(pe,{id:a,data:c,year:d.value.header.period,category:p.value,registered:b.value,"onUpdate:data":l=>t(a,l),onRemove:i},null,8,["id","data","year","category","registered","onUpdate:data"])]))),128)),f("div",xe,[e(B,{onClick:u},{default:n(()=>s[4]||(s[4]=[k(" Add Item ")])),_:1})])]),_:1}),e(J)]),_:1})}}},$e={class:"text-center text-h4 font-weight-medium my-2"},ia={__name:"[id]",async setup(R){let w,_;const V=ie(),d=re(),h=M(()=>V.params.id),t=g({header:{invoice:"",date:"",period:"",admin_student_id:""},paymentItem:[]});if(h.value&&h.value!=="new"){const{data:a}=([w,_]=ue(()=>P(`/payments-by-invoice/${h.value}`)),w=await w,_(),w);if(console.log("Raw invoiceData from API:",a.value),a.value&&a.value.data.length>0){const l=a.value.data,m=l[0];t.value.header={invoice:m.invoice,date:m.date,period:m.period,admin_student_id:m.admin_student_id},t.value.paymentItem=l}}const y=()=>{var a;(a=t.value)==null||a.paymentItem.push({finance_account_id:"",billing:"",amount:0})},p=a=>{var l;(l=t.value)==null||l.paymentItem.splice(a,1)},b=g(!1),C=g(""),u=g("primary"),i=(a,l="primary")=>{C.value=a,u.value=l,b.value=!0,setTimeout(()=>{b.value=!1},1e4)},o=M(()=>{var l;const a=t.value.header;if(!a.date||!a.period||!a.admin_student_id)return!1;if(((l=t.value)==null?void 0:l.paymentItem.length)>0){for(const m of t.value.paymentItem)if(!m.amount)return!1}return!0}),s=g(!1),r=async()=>{var l,m;s.value=!0;const a=U(t.value);h.value!=="new"&&(a.header.invoice=h.value);try{const{data:q,error:$}=await P("/payments/bulk-store",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json",Accept:"application/json"}});if($.value){if((l=$.value.data)!=null&&l.errors){const D=$.value.data.errors,X=Object.keys(D)[0],Z=D[X][0];i(`Save failed: ${Z}`,"error")}else(m=$.value.data)!=null&&m.message?i(`An error occurred: ${$.value.data.message}`,"error"):i("An unknown error occurred while saving. Please check the console.","error");console.error("Error saving payment:",$.value)}else d.push(`/financial/payment/edit/${q.value.data.invoice}`),i("Data berhasil disimpan!","success")}finally{s.value=!1}},c=M(()=>t.value.paymentItem.reduce((a,l)=>a+(Number(l.amount)||0),0));return(a,l)=>(S(),E(O,null,{default:n(()=>[e(x,{cols:"12",md:"12"},{default:n(()=>[e(de,{modelValue:v(b),"onUpdate:modelValue":l[0]||(l[0]=m=>K(b)?b.value=m:null),closable:"",class:"mb-6",color:v(u)},{default:n(()=>[k(I(v(C)),1)]),_:1},8,["modelValue","color"]),e(O,null,{default:n(()=>[e(x,{cols:"12",md:"9"},{default:n(()=>[v(t)?(S(),E(we,{key:0,data:v(t),"onUpdate:data":l[1]||(l[1]=m=>K(t)?t.value=m:null),"invoice-number":v(h),onPush:y,onRemove:p},null,8,["data","invoice-number"])):W("",!0)]),_:1}),e(x,{cols:"12",md:"3"},{default:n(()=>[e(T,{class:"mb-8"},{default:n(()=>[e(N,null,{default:n(()=>[e(B,{loading:v(s),disabled:!v(o),block:"",class:"mb-2",color:"success",onClick:r},{default:n(()=>l[2]||(l[2]=[k(" Save payment ")])),_:1},8,["loading","disabled"]),e(B,{block:"",color:"secondary",variant:"tonal",class:"mb-2",disabled:v(V).params.id==="new",to:{name:"financial-payment-preview-id",params:{id:v(V).params.id}}},{default:n(()=>l[3]||(l[3]=[k(" Preview ")])),_:1},8,["disabled","to"]),e(B,{block:"",color:"secondary",variant:"tonal",to:{name:"financial-payment-list"}},{default:n(()=>l[4]||(l[4]=[k(" Exit ")])),_:1})]),_:1})]),_:1}),e(T,null,{default:n(()=>[e(N,null,{default:n(()=>[l[5]||(l[5]=f("div",{class:"text-high-emphasis"}," Total ",-1)),f("div",$e,I(Number(v(c)).toLocaleString("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0})),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}};export{ia as default};
