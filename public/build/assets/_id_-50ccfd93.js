import{_ as Y}from"./AppSelect-b4c02f4e.js";import{_ as ee}from"./AppDateTimePicker-8a01f538.js";import{_ as j}from"./AppTextField-760889a8.js";import{e as ae}from"./helpers-ddaee727.js";import{f as te,s as z}from"./fetchStudentData-a63142dd.js";import{V as le}from"./VNodeRenderer-2847b45b.js";import{r as g,H as G,be as U,w as I,aY as Q,a as oe,o as k,f as E,e as n,d as f,b as a,a0 as F,c as M,n as p,I as H,x as $,v as A,z as W,F as ne,i as se,ai as B,j as ie,k as ue,a5 as J,b5 as re,aU as K}from"./main-d9f3424d.js";import{u as P}from"./useApi-608e4ca2.js";import{V as O}from"./VRow-da5b93ce.js";import{V as x}from"./VCol-ac94f502.js";import{V as T}from"./VCard-afaa5d27.js";import{V as D}from"./VCardText-cf9fd2ab.js";import{V as L}from"./VDivider-f6620f51.js";import{V as de}from"./VAlert-96b18c99.js";import"./form-26233cc1.js";import"./VSelect-1d333a1c.js";import"./VTextField-0356918e.js";/* empty css                   */import"./VCounter-17d4f7ca.js";import"./VImg-f55b59e7.js";import"./VField-9bf8b145.js";import"./easing-9f15041e.js";import"./VInput-ca1cb71d.js";import"./forwardRefs-8348545e.js";import"./VList-c368e352.js";import"./ssrBoot-51c609c5.js";import"./VAvatar-277a8b10.js";import"./dialog-transition-93f1260e.js";import"./VMenu-b53d0f28.js";import"./VOverlay-6cf31c8f.js";import"./lazy-3da88233.js";import"./scopeId-c2687b41.js";import"./VCheckboxBtn-bb1e1fec.js";import"./VSelectionControl-28f4217c.js";import"./VChip-b6bedac6.js";import"./no-profile-4221a4a6.js";const me={class:"pa-5 flex-grow-1"},ce={class:"d-flex flex-column justify-space-between border-s pa-1"},pe={__name:"paymentItemEdit",props:{id:{type:Number,required:!0},data:{type:Object,required:!0},year:{type:[String,Number],required:!0},category:{type:String,required:!0},registered:{type:[String,Number],required:!0}},emits:["remove","update:data"],setup(R,{emit:w}){const _=R,V=w,u=g([]);G(async()=>{const{data:d,error:i}=await P("/accounts");i.value?console.error("Error fetching accounts:",i.value):u.value=d.value.data.filter(o=>o.unit==="Pembayaran")});const t=g(structuredClone(U(_.data)));let y=!1;I(t,d=>{y||V("update:data",d)},{deep:!0}),I(()=>_.data,d=>{y=!0,t.value=structuredClone(U(d)),Q(()=>{y=!1})},{deep:!0});const v=g([]),b=async(d,i,o)=>{var s;if(!d||!i||i==="Not Set"){v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id="";return}try{const{data:m}=await P(`/billings-by-year/${o}/${i}`);if((s=m.value)!=null&&s.data){const r=["Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","Jun"];v.value=m.value.data.flatMap(e=>{if(e.is_monthly)return r.map((c,q)=>{const N=q<6?d:Number(d)+1,C=`${e.name} ${c}-${N}`;return{title:C,value:C,amount:e.amount,finance_account_id:Number(e.finance_account_id)}});if(e.is_once){const c=`${e.name} ${o}`;return{title:c,value:c,amount:e.amount,finance_account_id:Number(e.finance_account_id)}}const l=`${e.name} ${d}`;return{title:l,value:l,amount:e.amount,finance_account_id:Number(e.finance_account_id)}})}else v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}catch(m){console.error("Failed to fetch billings:",m),v.value=[],t.value.billing="",t.value.amount=0,t.value.finance_account_id=""}};I([()=>_.year,()=>_.category,()=>_.registered],([d,i,o])=>{i&&i!=="Not Set"&&b(d,i,o)},{immediate:!0}),I(()=>t.value.billing,d=>{if(d){const i=v.value.find(o=>o.value===d);i&&(t.value.amount=i.amount,t.value.finance_account_id=Number(i.finance_account_id))}else t.value.amount=0,t.value.finance_account_id=""});const S=()=>{V("remove",_.id)};return console.log("localData child child",t.value),(d,i)=>{const o=Y,s=oe("IconBtn");return k(),E(T,{flat:"",border:"",class:"d-flex flex-row"},{default:n(()=>[f("div",me,[a(O,null,{default:n(()=>[a(x,{cols:"12",sm:"5"},{default:n(()=>[a(o,{modelValue:t.value.billing,"onUpdate:modelValue":i[0]||(i[0]=m=>t.value.billing=m),label:"Description",placeholder:"Billing Description",items:v.value,"item-title":"title","item-value":"value"},null,8,["modelValue","items"])]),_:1}),a(x,{cols:"12",sm:"4"},{default:n(()=>[a(o,{modelValue:t.value.finance_account_id,"onUpdate:modelValue":i[1]||(i[1]=m=>t.value.finance_account_id=m),items:u.value,"item-title":m=>{const r=u.value.find(e=>e.id==(m.id||m));return r?`${r.number} - ${r.description}`:m.id||m},"item-value":"id",label:"Account"},null,8,["modelValue","items","item-title"])]),_:1}),a(x,{cols:"12",sm:"3"},{default:n(()=>[a(j,{modelValue:t.value.amount,"onUpdate:modelValue":i[2]||(i[2]=m=>t.value.amount=m),label:"Amount",placeholder:"Amount",type:"number"},null,8,["modelValue"])]),_:1})]),_:1})]),f("div",ce,[a(s,{onClick:S},{default:n(()=>[a(F,{size:"20",icon:"tabler-x"})]),_:1}),a(s,null,{default:n(()=>[a(F,{size:"20",icon:"tabler-settings"})]),_:1})])]),_:1})}}},ve={key:0,class:"ma-sm-4"},fe={class:"d-flex align-center mb-6"},_e={class:"font-weight-bold text-capitalize text-h4"},ye={class:"mb-0"},be={class:"my-2"},ge={class:"mb-0"},he={class:"mt-4 ma-sm-4"},Ve={class:"d-flex align-center font-weight-medium justify-sm-end text-xl mb-3"},xe={class:"mt-6 ms-sm-4"},we={__name:"paymentEditable",props:{invoiceNumber:String,data:{type:null,required:!0}},emits:["push","remove","update:data"],setup(R,{emit:w}){const _=R,V=w,u=g(structuredClone(U(_.data)));u.value.header.admin_student_id&&(u.value.header.admin_student_id=Number(u.value.header.admin_student_id));let h=!1;I(u,o=>{h||V("update:data",o)},{deep:!0}),I(()=>_.data,o=>{h=!0,u.value=structuredClone(U(o)),u.value.header.admin_student_id&&(u.value.header.admin_student_id=Number(u.value.header.admin_student_id)),Q(()=>{h=!1})},{deep:!0});const t=(o,s)=>{u.value.paymentItem[o]=s},y=g([]),v=g(""),b=g(0),S=async()=>{const{data:o,error:s}=await P("/schools");s.value?console.log(s.value):y.value=o.value};G(()=>{te(),S()}),I(()=>u.value.header.date,o=>{u.value.header.period=o?ae(o):""}),I(()=>u.value.header.admin_student_id,o=>{if(o){const s=z.value.find(m=>m.id===Number(o));s?(v.value=s.payment_category,b.value=s.registered||0):(v.value="",b.value=0)}else v.value="",b.value=0},{immediate:!0});const d=()=>{V("push")},i=o=>{V("remove",o)};return console.log("localData child",u.value),(o,s)=>{const m=Y;return k(),E(T,null,{default:n(()=>[a(D,{class:"d-flex flex-wrap justify-space-between gap-y-5 flex-column flex-sm-row"},{default:n(()=>{var r,e;return[(e=(r=y.value)==null?void 0:r.data)!=null&&e.length?(k(),M("div",ve,[f("div",fe,[a(p(le),{nodes:p(H).app.logo,class:"me-3"},null,8,["nodes"]),f("h6",_e,$(p(H).app.title),1)]),f("p",ye,[A($(y.value.data[0].name)+" âœª ",1),f("strong",null,$(y.value.data[0].organization),1)]),f("p",be,$(y.value.data[0].address),1),f("p",ge,[a(F,{icon:"tabler-phone",class:"me-2"}),A(" "+$(y.value.data[0].phone)+" ",1),a(F,{icon:"tabler-mail",class:"mx-2"}),A(" "+$(y.value.data[0].email),1)])])):W("",!0),f("div",he,[f("h6",Ve,[f("span",null,[a(j,{"model-value":_.invoiceNumber,disabled:"",prefix:"#",density:"compact",style:{"inline-size":"9.5rem"}},null,8,["model-value"])])])])]}),_:1}),a(L),a(D,{class:"d-flex flex-wrap justify-space-between flex-column flex-sm-row"},{default:n(()=>[a(O,null,{default:n(()=>[a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(ee,{modelValue:u.value.header.date,"onUpdate:modelValue":s[0]||(s[0]=r=>u.value.header.date=r),label:"Date",density:"compact"},null,8,["modelValue"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(j,{modelValue:u.value.header.period,"onUpdate:modelValue":s[1]||(s[1]=r=>u.value.header.period=r),label:"Period",type:"number",density:"compact"},null,8,["modelValue"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(m,{modelValue:u.value.header.admin_student_id,"onUpdate:modelValue":s[2]||(s[2]=r=>u.value.header.admin_student_id=r),items:p(z),"item-title":r=>{const e=p(z).find(l=>l.id==(r.id||r));return e?e.nickname:r.id||r},"item-value":"id",label:"Student",density:"compact"},null,8,["modelValue","items","item-title"])]),_:1}),a(x,{cols:"12",sm:"6",md:"3"},{default:n(()=>[a(j,{modelValue:v.value,"onUpdate:modelValue":s[3]||(s[3]=r=>v.value=r),label:"Payment Category",readonly:"",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(L),a(D,{class:"add-products-form"},{default:n(()=>[(k(!0),M(ne,null,se(u.value.paymentItem,(r,e)=>(k(),M("div",{key:e,class:"my-4 ma-sm-4"},[a(pe,{id:e,data:r,year:u.value.header.period,category:v.value,registered:b.value,"onUpdate:data":l=>t(e,l),onRemove:i},null,8,["id","data","year","category","registered","onUpdate:data"])]))),128)),f("div",xe,[a(B,{onClick:d},{default:n(()=>s[4]||(s[4]=[A(" Add Item ")])),_:1})])]),_:1}),a(L)]),_:1})}}},Ne={class:"text-center text-h4 font-weight-medium my-2"},ia={__name:"[id]",async setup(R){let w,_;const V=ie(),u=ue(),h=J(()=>V.params.id),t=g({header:{invoice:"",date:"",period:"",admin_student_id:""},paymentItem:[]});if(h.value&&h.value!=="new"){const{data:e}=([w,_]=re(()=>P(`/payments-by-invoice/${h.value}`)),w=await w,_(),w);if(console.log("Raw invoiceData from API:",e.value),e.value&&e.value.data.length>0){const l=e.value.data,c=l[0];t.value.header={invoice:c.invoice,date:c.date,period:c.period,admin_student_id:c.admin_student_id},t.value.paymentItem=l}}const y=()=>{var e;(e=t.value)==null||e.paymentItem.push({finance_account_id:"",billing:"",amount:0})},v=e=>{var l;(l=t.value)==null||l.paymentItem.splice(e,1)},b=g(!1),S=g(""),d=g("primary"),i=(e,l="primary")=>{S.value=e,d.value=l,b.value=!0,setTimeout(()=>{b.value=!1},1e4)},o=J(()=>{var l;const e=t.value.header;if(!e.date||!e.period||!e.admin_student_id)return!1;if(((l=t.value)==null?void 0:l.paymentItem.length)>0){for(const c of t.value.paymentItem)if(!c.amount)return!1}return!0}),s=g(!1),m=async()=>{var l,c;s.value=!0;const e=U(t.value);h.value!=="new"&&(e.header.invoice=h.value);try{const{data:q,error:N}=await P("/payments/bulk-store",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",Accept:"application/json"}});if(N.value){if((l=N.value.data)!=null&&l.errors){const C=N.value.data.errors,X=Object.keys(C)[0],Z=C[X][0];i(`Save failed: ${Z}`,"error")}else(c=N.value.data)!=null&&c.message?i(`An error occurred: ${N.value.data.message}`,"error"):i("An unknown error occurred while saving. Please check the console.","error");console.error("Error saving payment:",N.value)}else u.push(`/financial/payment/edit/${q.value.data.invoice}`),i("Data berhasil disimpan!","success")}finally{s.value=!1}},r=J(()=>t.value.paymentItem.reduce((e,l)=>e+(Number(l.amount)||0),0));return(e,l)=>(k(),E(O,null,{default:n(()=>[a(x,{cols:"12",md:"12"},{default:n(()=>[a(de,{modelValue:p(b),"onUpdate:modelValue":l[0]||(l[0]=c=>K(b)?b.value=c:null),closable:"",class:"mb-6",color:p(d)},{default:n(()=>[A($(p(S)),1)]),_:1},8,["modelValue","color"]),a(O,null,{default:n(()=>[a(x,{cols:"12",md:"9"},{default:n(()=>[p(t)?(k(),E(we,{key:0,data:p(t),"onUpdate:data":l[1]||(l[1]=c=>K(t)?t.value=c:null),"invoice-number":p(h),onPush:y,onRemove:v},null,8,["data","invoice-number"])):W("",!0)]),_:1}),a(x,{cols:"12",md:"3"},{default:n(()=>[a(T,{class:"mb-8"},{default:n(()=>[a(D,null,{default:n(()=>[a(B,{loading:p(s),disabled:!p(o),block:"",class:"mb-2",color:"success",onClick:m},{default:n(()=>l[2]||(l[2]=[A(" Save payment ")])),_:1},8,["loading","disabled"]),a(B,{block:"",color:"secondary",variant:"tonal",class:"mb-2",disabled:p(V).params.id==="new",to:{name:"financial-payment-preview-id",params:{id:p(V).params.id}}},{default:n(()=>l[3]||(l[3]=[A(" Preview ")])),_:1},8,["disabled","to"]),a(B,{block:"",color:"secondary",variant:"tonal",to:{name:"financial-payment-list"}},{default:n(()=>l[4]||(l[4]=[A(" Exit ")])),_:1})]),_:1})]),_:1}),a(T,null,{default:n(()=>[a(D,null,{default:n(()=>[l[5]||(l[5]=f("div",{class:"text-high-emphasis"}," Total ",-1)),f("div",Ne,$(Number(p(r)).toLocaleString("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0})),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}};export{ia as default};
