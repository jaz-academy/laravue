import{_ as N}from"./AppSelect-3e238d9d.js";import{u as Q}from"./helpers-10cbd28e.js";import{r as Z}from"./validators-77ed87b6.js";import{$ as ee,r as c,bc as ae,w as M,H as I,o as z,f as J,e as d,b as o,n as a,a$ as te,d as y,ai as O,v as b,x as V,z as K,aY as le,a5 as oe,a as ne,c as se,aU as h,a0 as R,s as H}from"./main-ee7c17de.js";import{_ as ie}from"./AppTextField-862a83a4.js";import{_ as re}from"./AppDrawerHeaderSection-50b9a772.js";import{f as de,s as L}from"./fetchStudentData-923239c4.js";import{P as ue}from"./vue3-perfect-scrollbar.esm-289cf486.js";import{u as T}from"./useApi-ee5b865a.js";import{V as Y}from"./VDivider-5a8f189b.js";import{V as W}from"./VCard-cba44afa.js";import{V as X}from"./VCardText-6be2f581.js";import{V as me}from"./VForm-e8199224.js";import{V as ce}from"./VRow-271260dd.js";import{V as g}from"./VCol-cfb71e73.js";import{V as pe}from"./VNavigationDrawer-fb2b3f9b.js";import{V as fe}from"./VAlert-8e2387b3.js";import{V as ve}from"./VTextField-65dae01b.js";import{V as _e}from"./VDataTable-505b1e1a.js";import{V as ye}from"./VAvatar-4667946e.js";import{V as ge}from"./VChip-7b4a1ec4.js";import{V as Ve}from"./VPagination-fdaafc26.js";import"./form-baa91886.js";import"./VSelect-cea4b28e.js";import"./forwardRefs-8348545e.js";import"./VList-dd2cb195.js";import"./ssrBoot-c8beb59b.js";import"./VImg-d487f910.js";import"./dialog-transition-9860be03.js";import"./easing-9f15041e.js";import"./VMenu-6af39dc3.js";import"./VOverlay-9c9ed528.js";import"./lazy-ad9bbcd3.js";import"./scopeId-f06193c4.js";import"./VCheckboxBtn-0cef0367.js";import"./VSelectionControl-fc422a63.js";import"./no-profile-4221a4a6.js";import"./VSpacer-74f2d191.js";/* empty css                   */import"./VCounter-97a26890.js";import"./VField-2b6b59c0.js";import"./VInput-29651115.js";import"./VTable-4dc70b45.js";import"./filter-dffb0502.js";const be={class:"d-flex justify-start"},De={__name:"AddDiscount",props:{isDrawerOpen:{type:Boolean,required:!0},mode:{type:String,default:"add"},selectedData:{type:Object,default:()=>({})}},emits:["update:isDrawerOpen","selectedData"],setup(q,{emit:$}){var v;const u=q,D=$,x=ee("userData"),f=c(),U=c(!1),{hasRole:B}=Q(),i=ae({admin_student_id:"",payment_category:"",year:"",finance_account_id:"",billing:"",amount:"",note:"",admin:((v=x.value)==null?void 0:v.name)||""}),_=c([]),p=c([]),S=c(0),A=c(!1);M(()=>[u.selectedData,u.mode],()=>{var n;u.mode==="edit"&&u.selectedData?(A.value=!1,Object.assign(i,{admin_student_id:u.selectedData.admin_student_id||0,payment_category:"",year:u.selectedData.year||"",finance_account_id:u.selectedData.finance_account_id||0,billing:u.selectedData.billing||"",amount:u.selectedData.amount||0,note:u.selectedData.note||"",admin:u.selectedData.admin||""})):(A.value=!0,Object.assign(i,{admin_student_id:"",payment_category:"",year:"",finance_account_id:"",billing:"",amount:"",note:"",admin:((n=x.value)==null?void 0:n.name)||""}),_.value=[],p.value=[])},{immediate:!0}),M(()=>u.isDrawerOpen,n=>{var e,t;n||((e=f.value)==null||e.reset(),(t=f.value)==null||t.resetValidation(),_.value=[],p.value=[])}),M(()=>i.admin_student_id,n=>{if(n){const e=L.value.find(t=>t.id===n);if(e){i.payment_category=e.payment_category||"Not Set";const t=parseInt(e.registered);isNaN(t)||(S.value=t,_.value=Array.from({length:6},(l,s)=>t+s),(u.mode!=="edit"||!i.year)&&(i.year=t))}}else i.payment_category="",i.year="",i.billing="",_.value=[],p.value=[]});const w=async(n,e)=>{var t;if(!n||!e||e==="Not Set"){p.value=[];return}try{const{data:l}=await T(`/billings-by-year/${S.value}/${e}`);if((t=l.value)!=null&&t.data){const s=["Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar","Apr","May","Jun"];p.value=l.value.data.flatMap(m=>m.is_monthly?s.map((r,P)=>{const j=P<6?n:Number(n)+1;return`${m.name} ${r}-${j}`}):m.is_once?`${m.name} ${S.value}`:`${m.name} ${n}`)}else p.value=[]}catch(l){console.error("Failed to fetch billings:",l),p.value=[]}};M([()=>i.year,()=>i.payment_category],([n,e])=>{A.value&&(i.billing=""),w(n,e),A.value=!0});const C=n=>{D("update:isDrawerOpen",n)},k=()=>{var n,e;(n=f.value)==null||n.reset(),(e=f.value)==null||e.resetValidation()},E=()=>{var n;(n=f.value)==null||n.validate().then(({valid:e})=>{if(!e)return;const t={...i};u.mode==="edit"?(t.id=u.selectedData.id,D("selectedData",{action:"update",data:t})):D("selectedData",{action:"create",data:t}),D("update:isDrawerOpen",!1),le(k)})},F=c();return I(async()=>{const{data:n,error:e}=await T("/accounts");e.value?console.log(e.value):F.value=n.value.data.filter(t=>t.unit==="Pembayaran")}),I(de),(n,e)=>{const t=re,l=ie;return z(),J(pe,{"model-value":u.isDrawerOpen,temporary:"",location:"end",width:"370",class:"category-navigation-drawer scrollable-content","onUpdate:modelValue":C},{default:d(()=>[o(t,{title:u.mode==="edit"?"Edit Discount":"Add New Discount",onCancel:e[0]||(e[0]=s=>n.$emit("update:isDrawerOpen",!1))},null,8,["title"]),o(Y),o(a(ue),{options:{wheelPropagation:!1}},{default:d(()=>[o(W,{flat:""},{default:d(()=>[o(X,null,{default:d(()=>[o(a(me),{ref_key:"refVForm",ref:f,modelValue:U.value,"onUpdate:modelValue":e[9]||(e[9]=s=>U.value=s),onSubmit:te(E,["prevent"])},{default:d(()=>[o(ce,null,{default:d(()=>[o(g,{cols:"12"},{default:d(()=>[o(N,{modelValue:a(i).admin_student_id,"onUpdate:modelValue":e[1]||(e[1]=s=>a(i).admin_student_id=s),label:"Student",rules:["requiredValidator"in n?n.requiredValidator:a(Z)],items:a(L),"item-title":"nickname","item-value":"id",placeholder:"Choose Student"},null,8,["modelValue","rules","items"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(l,{modelValue:a(i).payment_category,"onUpdate:modelValue":e[2]||(e[2]=s=>a(i).payment_category=s),label:"Payment Category",placeholder:"Auto-filled",readonly:"",disabled:""},null,8,["modelValue"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(N,{modelValue:a(i).year,"onUpdate:modelValue":e[3]||(e[3]=s=>a(i).year=s),label:"Year",placeholder:"Tahun Diskon",items:_.value},null,8,["modelValue","items"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(N,{modelValue:a(i).finance_account_id,"onUpdate:modelValue":e[4]||(e[4]=s=>a(i).finance_account_id=s),items:F.value,"item-title":s=>s!=null&&s.number&&(s!=null&&s.description)?`${s.number} - ${s.description}`:"","item-value":"id",label:"Account"},null,8,["modelValue","items","item-title"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(N,{modelValue:a(i).billing,"onUpdate:modelValue":e[5]||(e[5]=s=>a(i).billing=s),label:"Billing",placeholder:"Pilih Tagihan",items:p.value},null,8,["modelValue","items"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(l,{modelValue:a(i).amount,"onUpdate:modelValue":e[6]||(e[6]=s=>a(i).amount=s),label:"Amount",placeholder:"Jumlah Potongan"},null,8,["modelValue"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(l,{modelValue:a(i).note,"onUpdate:modelValue":e[7]||(e[7]=s=>a(i).note=s),label:"Note",placeholder:"Catatan"},null,8,["modelValue"])]),_:1}),o(g,{cols:"12"},{default:d(()=>[o(l,{modelValue:a(i).admin,"onUpdate:modelValue":e[8]||(e[8]=s=>a(i).admin=s),label:"Admin",placeholder:"Admin",readonly:"",disabled:""},null,8,["modelValue"])]),_:1}),a(B)(4).value?(z(),J(g,{key:0,cols:"12"},{default:d(()=>[y("div",be,[o(a(O),{type:"submit",color:"primary",class:"me-4"},{default:d(()=>[b(V(u.mode==="edit"?"Update":"Add"),1)]),_:1}),o(a(O),{color:"error",variant:"tonal",onClick:k},{default:d(()=>e[10]||(e[10]=[b(" Discard ")])),_:1})])]),_:1})):K("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value"])}}};const we={class:"d-flex justify-sm-space-between flex-wrap gap-y-4 gap-x-6 justify-start"},he={class:"d-flex align-center flex-wrap gap-4"},xe={class:"data-table"},Ae={class:"d-flex align-center gap-x-2"},ke={class:"d-flex flex-column"},$e={class:"text-body-1 font-weight-medium"},Ue={class:"text-sm text-disabled"},Se={class:"d-flex align-center justify-space-between flex-wrap gap-3 pa-5 pt-3"},Ce={class:"text-sm text-medium-emphasis mb-0"},wa={__name:"index",setup(q){const{hasRoleAndAccess:$,currentUser:u}=Q(),D=c([]),x=async()=>{const{data:t}=await T("/discounts");D.value=t.value.data||[]};I(x);const f=c(!1),U=c(""),B=c("primary"),i=(t,l="primary")=>{U.value=t,B.value=l,f.value=!0,setTimeout(()=>{f.value=!1},1e4)},_=oe(()=>D.value.slice().sort((t,l)=>l.id-t.id).map((t,l)=>({no:l+1,id:t.id||"",student:t.admin_student.name||"",admin_student_id:t.admin_student_id||"",year:t.year||"",finance_account_id:t.finance_account_id||"",billing:t.billing||"",amount:t.amount||"",note:t.note||"",admin:t.admin||""}))),p=["primary","success","warning","error","info","secondary"],S=[{title:"Student",key:"student"},{title:"Year",key:"year"},{title:"Billing",key:"billing"},{title:"Amount",key:"amount"},{title:"Action",key:"actions",sortable:!1}],A=async({action:t,data:l})=>{var s;console.log("Sending discount data:",l,"action:",t);try{let m="/discounts",r="POST";t==="update"&&l.id&&(m=`/discounts/${l.id}`,r="PUT");const{data:P,response:j}=await T(m,{method:r,body:JSON.stringify(l),headers:{"Content-Type":"application/json",Accept:"application/json"}});j.value.ok?(i(t==="create"?"Data berhasil ditambahkan":"Data berhasil diperbarui","success"),console.log("Response discount data:",P),x()):i(j.value.statusText||"Gagal menyimpan data","error")}catch(m){console.error("Save error:",((s=m==null?void 0:m.data)==null?void 0:s.errors)||m),i(m.message||"Gagal menyimpan data","error")}},w=c(!1),C=c("add"),k=c({}),E=t=>{k.value={...t},C.value="edit",w.value=!0},F=()=>{k.value={},C.value="add",w.value=!0},G=async t=>{try{confirm("Apakah kamu yakin ingin menghapus data ini?")&&(console.log("Deleting discount data with ID:",t),await T(`/discounts/${t}`,{method:"DELETE"}),i("Data berhasil dihapus","success")),x()}catch(l){i(l.message||"Gagal menghapus data","error"),console.error(l)}},v=c(10),n=c(1),e=c("");return(t,l)=>{const s=N,m=ne("IconBtn");return z(),se("div",null,[o(fe,{modelValue:a(f),"onUpdate:modelValue":l[0]||(l[0]=r=>h(f)?f.value=r:null),closable:"",class:"mb-6",color:a(B)},{default:d(()=>[b(V(a(U)),1)]),_:1},8,["modelValue","color"]),o(W,null,{default:d(()=>[o(X,null,{default:d(()=>[y("div",we,[o(ve,{modelValue:a(e),"onUpdate:modelValue":l[1]||(l[1]=r=>h(e)?e.value=r:null),placeholder:"Search",density:"compact",style:{"max-inline-size":"200px","min-inline-size":"200px"}},null,8,["modelValue"]),y("div",he,[o(s,{modelValue:a(v),"onUpdate:modelValue":l[2]||(l[2]=r=>h(v)?v.value=r:null),items:[5,10,15]},null,8,["modelValue"]),o(O,{"prepend-icon":"tabler-plus",onClick:F},{default:d(()=>l[7]||(l[7]=[b(" Add Data discount ")])),_:1})])])]),_:1}),o(Y),y("div",xe,[o(a(_e),{"items-per-page":a(v),"onUpdate:itemsPerPage":l[4]||(l[4]=r=>h(v)?v.value=r:null),page:a(n),"onUpdate:page":l[5]||(l[5]=r=>h(n)?n.value=r:null),headers:S,items:a(_),search:a(e),"item-value":"number",class:"text-no-wrap","show-select":""},{"item.student":d(({item:r})=>[y("div",Ae,[r.student?(z(),J(ye,{key:0,size:"38",variant:"tonal",color:p[r.admin_student_id%p.length],rounded:""},{default:d(()=>[o(R,{icon:"tabler-file-text"})]),_:2},1032,["color"])):K("",!0),y("div",ke,[y("span",$e,V(r.student),1),y("span",Ue,V(r.year),1)])])]),"item.year":d(({item:r})=>[o(ge,{color:p[r.admin_student_id%p.length],size:"small",class:"text-capitalize",label:""},{default:d(()=>[b(V(r.year),1)]),_:2},1032,["color"])]),"item.amount":d(({item:r})=>[b(V(Number(r.amount).toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:0})),1)]),"item.actions":d(({item:r})=>[o(m,{disabled:!a($)(4,"Payment").value,color:a($)(4,"Payment").value?"error":"secondary",onClick:P=>G(r.id)},{default:d(()=>[o(R,{icon:"tabler-trash"})]),_:2},1032,["disabled","color","onClick"]),o(m,{color:"primary",onClick:P=>E(r)},{default:d(()=>[o(R,{icon:a($)(3,"Payment").value?"tabler-edit":"tabler-eye"},null,8,["icon"])]),_:2},1032,["onClick"])]),bottom:d(()=>[o(Y),y("div",Se,[y("p",Ce," showing "+V(a(v)*(a(n)-1)+1)+" to "+V(Math.min(a(v)*a(n),a(_).length))+" of "+V(a(_).length)+" entries ",1),o(Ve,{modelValue:a(n),"onUpdate:modelValue":l[3]||(l[3]=r=>h(n)?n.value=r:null),length:Math.ceil(a(_).length/a(v)),"total-visible":5},{prev:d(r=>[o(O,H({variant:"tonal",color:"default"},r,{icon:!1}),{default:d(()=>l[8]||(l[8]=[b(" Previous ")])),_:2},1040)]),next:d(r=>[o(O,H({variant:"tonal",color:"default"},r,{icon:!1}),{default:d(()=>l[9]||(l[9]=[b(" Next ")])),_:2},1040)]),_:1},8,["modelValue","length"])])]),_:1},8,["items-per-page","page","items","search"])])]),_:1}),o(De,{"is-drawer-open":a(w),"onUpdate:isDrawerOpen":l[6]||(l[6]=r=>h(w)?w.value=r:null),mode:a(C),"selected-data":a(k),onSelectedData:A},null,8,["is-drawer-open","mode","selected-data"])])}}};export{wa as default};
